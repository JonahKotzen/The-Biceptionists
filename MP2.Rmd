---
title: "MP2"
author: "Jonah Kotzen"
date: "2024-02-08"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
```


```{r load, include = FALSE}

arm_dat <- read_csv("MP2.csv")

# Convert cm to m and g to kg
arm_dat <- arm_dat %>%
  mutate(
    Larm = Larm / 100,
    Li = Li / 100,
    Lout = Lout/ 100,
    Mmuscle = Mmuscle / 1000
  )

``` 

# Define Functions for Calculations

```{r chunk 1, include=TRUE}
# Corrected and simplified functions for biomechanical calculations
law_cos <- function(l, r, o) {
  theta <- acos((-o^2 + l^2 + r^2) / (2 * l * r))
  return(theta)
}

# Corrected law_cos2 function
law_cos2 <- function(l, r, theta) {
  o <- sqrt(l^2 + r^2 - 2 * l * r * cos(theta))
  return(o)
}

force_length_factor <- function(Lmuscle, Lmuscler) {
  Lopt <- Lmuscler * 0.8
  ffl <- -6.25 * (Lmuscle / Lopt)^2 + 12.5 * (Lmuscle / Lopt) - 5.25
  return(ffl)
}

calculate_Fmax <- function(Mmuscle, Lmuscler, rho = 0.00105, phi = 0, k = 80) {
  PCSA <- (Mmuscle * cos(phi)) / (rho * Lmuscler)
  Fmax <- PCSA * k
  return(Fmax)
}


```


## The Model Function

```{r chunk5, include=TRUE}
model <- function(Mmuscle, Lmuscler, Lmuscle, theta, Li, rho = 0.00105, k = 80) {
   # Convert Lmuscler from m to cm for PCSA calculation (as ρ is given in kg/cm^3)
  Lmuscler_cm <- Lmuscler * 100
  # Assuming phi is 0 as the muscle is nonpennate
  phi <- 0
  # PCSA calculation
  PCSA <- (Mmuscle * cos(phi)) / (rho * Lmuscler_cm)
  # Fmax calculation
  Fmax <- PCSA * k
  # Force-length relationship factor (ffl)
  ffl <- force_length_factor(Lmuscle, Lmuscler)
  # Muscle force (Fmuscle)
  Fmuscle <- Fmax * ffl
  # Torque calculation (τmuscle)
  tau_muscle <- Fmuscle * sin(theta) * Li
  return(tau_muscle)
}
```


# Applying the Model

## Tibble for Angles & Gravity Constant (g)
```{r chunk6, include=TRUE}
angles_tibble <- tibble(
  flexion_deg = c(50, 75, 100, 125, 150),
  flexion_rad = flexion_deg * pi / 180
)

# Assuming g = 9.81 m/s^2
g <- 9.81
```


```{r chunk7, include=TRUE}
# Calculate Lmuscle, theta, muscle_torque, and max_mass for each flexion angle
dat <- arm_dat %>%
  cross_join(angles_tibble) %>%
  rowwise() %>%
  mutate(
    Lmuscle = law_cos2(Li, Larm, flexion_deg),#IS THIS SUPPOSED TO BE FLEX DEG OR FLEX RAD????? *crucial*
    theta = law_cos(Li, Lmuscle, Larm),
    muscle_torque = model(Mmuscle, Larm, Lmuscle, theta, Li),
    max_mass = muscle_torque / (Lout * g)
  ) %>%
  ungroup()

# Display the updated tibble
print(dat)

```

